services:
  - type: web
    name: stockfolio-web
    env: python
    plan: free
    buildCommand: "./build.sh"
    startCommand: "gunicorn stockfolio.wsgi:application"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5

  - type: postgres
    name: stockfolio-db
    plan: free
    ipAllowList: [] # only allow internal connections
    databaseName: stockfolio_db
    user: stockfolio_user

  # Cron job to scrape stock data daily (runs every day at 12:30 AM EST / 5:30 AM UTC)
  - type: cron
    name: stockfolio-daily-scrape
    env: python
    plan: free
    schedule: "30 5 * * *"  # Every day at 5:30 AM UTC (12:30 AM EST)
    buildCommand: "./build.sh"
    startCommand: "python manage.py daily_scrape --days 60"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: stockfolio-web
          property: SECRET_KEY
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5
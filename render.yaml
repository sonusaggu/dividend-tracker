services:
  - type: web
    name: stockfolio-web
    env: python
    plan: free
    buildCommand: "./build.sh"
    startCommand: "gunicorn stockfolio.wsgi:application --timeout 120 --workers 2 --threads 4"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5
      # Resend API Configuration (RECOMMENDED)
      # Get API key from https://resend.com/api-keys
      # Note: Requires verified domain for production use
      - key: RESEND_API_KEY
        sync: false  # Your Resend API key from https://resend.com/api-keys
      - key: RESEND_FROM_EMAIL
        sync: false  # Verified sender email (e.g., noreply@yourdomain.com)
      # Fallback: Local SMTP Configuration (if Resend not used)
      - key: EMAIL_BACKEND
        value: "django.core.mail.backends.smtp.EmailBackend"
      - key: EMAIL_HOST
        sync: false  # smtp.gmail.com (for local SMTP fallback)
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_USE_TLS
        value: "True"
      - key: EMAIL_HOST_USER
        sync: false  # Your email (for local SMTP fallback)
      - key: EMAIL_HOST_PASSWORD
        sync: false  # Gmail App Password (for local SMTP fallback)
      - key: DEFAULT_FROM_EMAIL
        sync: false  # Your email

  - type: postgres
    name: stockfolio-db
    plan: free
    ipAllowList: [] # only allow internal connections
    databaseName: stockfolio_db
    user: stockfolio_user

  # Cron job to scrape stock data daily (runs every day at 12:30 AM EST / 5:30 AM UTC)
  - type: cron
    name: stockfolio-daily-scrape
    env: python
    plan: free
    schedule: "30 5 * * *"  # Every day at 5:30 AM UTC (12:30 AM EST)
    buildCommand: "./build.sh"
    startCommand: "python manage.py daily_scrape --days 60"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: stockfolio-web
          property: SECRET_KEY
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5

  # Cron job to send weekly newsletters (runs every Monday at 9 AM EST / 2 PM UTC)
  - type: cron
    name: stockfolio-weekly-newsletter
    env: python
    plan: free
    schedule: "0 14 * * 1"  # Every Monday at 2 PM UTC (9 AM EST)
    buildCommand: "./build.sh"
    startCommand: "python manage.py send_dividend_newsletter"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: stockfolio-web
          property: SECRET_KEY
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5
      # Resend API Configuration (RECOMMENDED)
      - key: RESEND_API_KEY
        sync: false  # Your Resend API key from https://resend.com/api-keys
      - key: RESEND_FROM_EMAIL
        sync: false  # Verified sender email (e.g., noreply@yourdomain.com)
      # Fallback: Local SMTP (if Resend not used)
      - key: EMAIL_BACKEND
        value: "django.core.mail.backends.smtp.EmailBackend"
      - key: EMAIL_HOST
        sync: false  # smtp.gmail.com
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_USE_TLS
        value: "True"
      - key: EMAIL_HOST_USER
        sync: false  # Your email
      - key: EMAIL_HOST_PASSWORD
        sync: false  # Gmail App Password
      - key: DEFAULT_FROM_EMAIL
        sync: false  # Your email

  # Cron job to fetch news daily (runs every day at 8 AM UTC / 3 AM EST)
  # Automatically cleans up old news after fetching (30 days retention, 50 per stock)
  - type: cron
    name: stockfolio-news-fetch
    env: python
    plan: free
    schedule: "0 8 * * *"  # Every day at 8 AM UTC (3 AM EST)
    buildCommand: "./build.sh"
    startCommand: "python manage.py fetch_stock_news --cleanup-days 30 --cleanup-keep-per-stock 50"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: stockfolio-web
          property: SECRET_KEY
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5
      - key: NEWSAPI_KEY
        sync: false  # Set manually in Render Dashboard (optional)
      - key: ALPHA_VANTAGE_KEY
        sync: false  # Set manually in Render Dashboard (optional)

  # Cron job to clean up old news weekly (runs every Sunday at 2 AM UTC / Saturday 9 PM EST)
  - type: cron
    name: stockfolio-news-cleanup
    env: python
    plan: free
    schedule: "0 2 * * 0"  # Every Sunday at 2 AM UTC (Saturday 9 PM EST)
    buildCommand: "./build.sh"
    startCommand: "python manage.py cleanup_old_news --days 30 --keep-per-stock 50"
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: stockfolio-db
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: stockfolio-web
          property: SECRET_KEY
      - key: DEBUG
        value: "False"
      - key: PYTHON_VERSION
        value: 3.11.5
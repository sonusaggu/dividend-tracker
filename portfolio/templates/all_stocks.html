{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}All Stocks - Browse TSX Dividend Stocks | StockFolio{% endblock %}
{% block meta_title %}Browse All TSX Dividend Stocks - Dividend Screener & Filter{% endblock %}
{% block meta_description %}Browse and search all TSX dividend stocks. Filter by sector, dividend yield, price, and frequency. Find high-yield Canadian dividend stocks and build your portfolio.{% endblock %}
{% block meta_keywords %}all stocks, TSX stocks, dividend stocks list, stock screener, TSX dividend stocks, Canadian dividend stocks, high yield dividend stocks, dividend filter, filter by sector, dividend yield filter, stock search, TSX dividend list, Canadian stocks, dividend investing, stock screener Canada{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Simple Header -->
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-1 sm:mb-2">All Stocks</h1>
            <p class="text-sm sm:text-base text-gray-600">Browse and search dividend-paying stocks on TSX</p>
        </div>

        <!-- Registration Prompt for Non-Authenticated Users -->
        {% if not user.is_authenticated %}
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg p-4 sm:p-6 mb-4 sm:mb-6 text-white">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg sm:text-xl font-bold mb-2">ðŸ”’ Limited Preview</h3>
                    <p class="text-sm sm:text-base text-blue-50">
                        You're viewing only <strong>10 stocks</strong>. <a href="{% url 'register' %}" class="underline font-semibold hover:text-white">Sign up for free</a> to access all {{ dividend_stocks_count|intcomma }}+ dividend stocks, advanced filters, and portfolio tracking!
                    </p>
                </div>
                <div class="flex gap-2 sm:flex-shrink-0">
                    <a href="{% url 'register' %}" class="px-4 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-blue-50 transition whitespace-nowrap">
                        Sign Up Free
                    </a>
                    <a href="{% url 'login' %}" class="px-4 py-2 bg-blue-400 text-white rounded-lg font-semibold hover:bg-blue-500 transition whitespace-nowrap">
                        Sign In
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Stats Bar -->
        <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-4 sm:mb-6">
            <div class="bg-white rounded-lg p-3 sm:p-4 border border-gray-200">
                <div class="text-xl sm:text-2xl font-bold text-gray-900">
                    {% if user.is_authenticated %}{{ page_obj.paginator.count|intcomma }}{% else %}10{% endif %}
                </div>
                <div class="text-xs sm:text-sm text-gray-600">Total Stocks{% if not user.is_authenticated %} (Preview){% endif %}</div>
            </div>
            <div class="bg-white rounded-lg p-3 sm:p-4 border border-gray-200">
                <div class="text-xl sm:text-2xl font-bold text-gray-900">{{ dividend_stocks_count|intcomma }}</div>
                <div class="text-xs sm:text-sm text-gray-600">Dividend Payers</div>
            </div>
            <div class="bg-white rounded-lg p-3 sm:p-4 border border-gray-200">
                <div class="text-xl sm:text-2xl font-bold text-gray-900">{{ sectors_count|intcomma }}</div>
                <div class="text-xs sm:text-sm text-gray-600">Sectors</div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 mb-4 sm:mb-6">
            <form method="get" class="space-y-4">
                <!-- Basic Filters Row -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 sm:gap-4">
                    <!-- Search Input -->
                    <div class="md:col-span-2 relative" id="search-container">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Search</label>
                        <input 
                            type="text" 
                            id="stock-search-input"
                            name="search" 
                            placeholder="Symbol or company name..." 
                            value="{{ search_query }}"
                            autocomplete="off"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                        >
                        <div id="autocomplete-results" class="hidden absolute top-full left-0 right-0 z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-96 overflow-y-auto"></div>
                        <div id="recent-searches" class="hidden absolute top-full left-0 right-0 z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg">
                            <div class="p-3 border-b border-gray-200">
                                <h4 class="text-sm font-semibold text-gray-700">Recent Searches</h4>
                            </div>
                            <div id="recent-searches-list" class="p-2">
                                {% for search in recent_searches %}
                                <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 recent-search-item" data-search="{{ search }}">
                                    <svg class="w-4 h-4 text-gray-400 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>{{ search }}
                                </button>
                                {% empty %}
                                <p class="px-4 py-2 text-sm text-gray-500">No recent searches</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sector Filter -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Sector</label>
                        <select 
                            name="sector" 
                            class="w-full px-3 py-2 sm:px-4 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base bg-white"
                        >
                            <option value="">All Sectors</option>
                            {% for sector in sectors %}
                            <option value="{{ sector }}" {% if sector_filter == sector %}selected{% endif %}>{{ sector }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Sort -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Sort By</label>
                        <select 
                            name="sort_by" 
                            class="w-full px-3 py-2 sm:px-4 sm:py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base bg-white"
                        >
                            <option value="dividend_date" {% if sort_by == 'dividend_date' %}selected{% endif %}>Upcoming Dividend</option>
                            <option value="dividend_amount" {% if sort_by == 'dividend_amount' %}selected{% endif %}>Dividend Amount</option>
                            <option value="yield" {% if sort_by == 'yield' %}selected{% endif %}>Dividend Yield</option>
                            <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price (High to Low)</option>
                            <option value="market_cap" {% if sort_by == 'market_cap' %}selected{% endif %}>Market Cap</option>
                            <option value="pe_ratio" {% if sort_by == 'pe_ratio' %}selected{% endif %}>P/E Ratio</option>
                            <option value="symbol" {% if sort_by == 'symbol' %}selected{% endif %}>Symbol (A-Z)</option>
                            <option value="sector" {% if sort_by == 'sector' %}selected{% endif %}>Sector</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Filters (Collapsible) -->
                <details class="group">
                    <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-blue-600 transition flex items-center gap-2">
                        <svg class="w-4 h-4 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        Advanced Filters
                    </summary>
                    <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                        <!-- Yield Range -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Min Yield (%)</label>
                            <input 
                                type="number" 
                                name="min_yield" 
                                step="0.1" 
                                min="0" 
                                max="100"
                                value="{{ min_yield }}"
                                placeholder="0.0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                            >
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Max Yield (%)</label>
                            <input 
                                type="number" 
                                name="max_yield" 
                                step="0.1" 
                                min="0" 
                                max="100"
                                value="{{ max_yield }}"
                                placeholder="100.0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                            >
                        </div>
                        
                        <!-- Price Range -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Min Price ($)</label>
                            <input 
                                type="number" 
                                name="min_price" 
                                step="0.01" 
                                min="0"
                                value="{{ min_price }}"
                                placeholder="0.00"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                            >
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Max Price ($)</label>
                            <input 
                                type="number" 
                                name="max_price" 
                                step="0.01" 
                                min="0"
                                value="{{ max_price }}"
                                placeholder="9999.99"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                            >
                        </div>
                        
                        <!-- Dividend Frequency -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Frequency</label>
                            <select 
                                name="frequency" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
                            >
                                <option value="">All Frequencies</option>
                                {% for freq in frequencies %}
                                <option value="{{ freq }}" {% if dividend_frequency == freq %}selected{% endif %}>{{ freq }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Has Dividend -->
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Dividend Status</label>
                            <select 
                                name="has_dividend" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
                            >
                                <option value="">All Stocks</option>
                                <option value="yes" {% if has_dividend_filter == 'yes' %}selected{% endif %}>Has Dividends</option>
                                <option value="no" {% if has_dividend_filter == 'no' %}selected{% endif %}>No Dividends</option>
                            </select>
                        </div>
                        
                        <!-- TSX 60 & ETF Checkboxes -->
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="tsx60" 
                                    {% if tsx60_only %}checked{% endif %}
                                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                >
                                <span class="text-sm text-gray-700">TSX 60 Only</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="etf" 
                                    {% if etf_only %}checked{% endif %}
                                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                >
                                <span class="text-sm text-gray-700">ETF Only</span>
                            </label>
                        </div>
                    </div>
                </details>
                
                <!-- Active Filter Chips -->
                {% if search_query or sector_filter or min_yield or max_yield or min_price or max_price or dividend_frequency or tsx60_only or etf_only or has_dividend_filter %}
                <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200">
                    <span class="text-xs font-medium text-gray-600">Active Filters:</span>
                    {% if search_query %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                        Search: {{ search_query }}
                        <a href="?{% if sector_filter %}sector={{ sector_filter }}&{% endif %}{% if min_yield %}min_yield={{ min_yield }}&{% endif %}{% if max_yield %}max_yield={{ max_yield }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if dividend_frequency %}frequency={{ dividend_frequency }}&{% endif %}{% if tsx60_only %}tsx60=on&{% endif %}{% if etf_only %}etf=on&{% endif %}{% if has_dividend_filter %}has_dividend={{ has_dividend_filter }}&{% endif %}sort_by={{ sort_by }}" class="hover:text-blue-900">Ã—</a>
                    </span>
                    {% endif %}
                    {% if sector_filter %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                        Sector: {{ sector_filter }}
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if min_yield %}min_yield={{ min_yield }}&{% endif %}{% if max_yield %}max_yield={{ max_yield }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if dividend_frequency %}frequency={{ dividend_frequency }}&{% endif %}{% if tsx60_only %}tsx60=on&{% endif %}{% if etf_only %}etf=on&{% endif %}{% if has_dividend_filter %}has_dividend={{ has_dividend_filter }}&{% endif %}sort_by={{ sort_by }}" class="hover:text-green-900">Ã—</a>
                    </span>
                    {% endif %}
                    {% if min_yield or max_yield %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                        Yield: {% if min_yield %}{{ min_yield }}{% else %}0{% endif %}% - {% if max_yield %}{{ max_yield }}{% else %}100{% endif %}%
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if sector_filter %}sector={{ sector_filter }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if dividend_frequency %}frequency={{ dividend_frequency }}&{% endif %}{% if tsx60_only %}tsx60=on&{% endif %}{% if etf_only %}etf=on&{% endif %}{% if has_dividend_filter %}has_dividend={{ has_dividend_filter }}&{% endif %}sort_by={{ sort_by }}" class="hover:text-purple-900">Ã—</a>
                    </span>
                    {% endif %}
                    {% if tsx60_only %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                        TSX 60
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if sector_filter %}sector={{ sector_filter }}&{% endif %}{% if min_yield %}min_yield={{ min_yield }}&{% endif %}{% if max_yield %}max_yield={{ max_yield }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if dividend_frequency %}frequency={{ dividend_frequency }}&{% endif %}{% if etf_only %}etf=on&{% endif %}{% if has_dividend_filter %}has_dividend={{ has_dividend_filter }}&{% endif %}sort_by={{ sort_by }}" class="hover:text-yellow-900">Ã—</a>
                    </span>
                    {% endif %}
                    {% if etf_only %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                        ETF
                        <a href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if sector_filter %}sector={{ sector_filter }}&{% endif %}{% if min_yield %}min_yield={{ min_yield }}&{% endif %}{% if max_yield %}max_yield={{ max_yield }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if dividend_frequency %}frequency={{ dividend_frequency }}&{% endif %}{% if tsx60_only %}tsx60=on&{% endif %}{% if has_dividend_filter %}has_dividend={{ has_dividend_filter }}&{% endif %}sort_by={{ sort_by }}" class="hover:text-indigo-900">Ã—</a>
                    </span>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 pt-2">
                    <button 
                        type="submit" 
                        class="px-4 py-2 sm:px-6 sm:py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition text-sm sm:text-base whitespace-nowrap"
                    >
                        Apply Filters
                    </button>
                    {% if search_query or sector_filter or min_yield or max_yield or min_price or max_price or dividend_frequency or tsx60_only or etf_only or has_dividend_filter or sort_by != 'dividend_date' %}
                    <a 
                        href="{% url 'all_stocks' %}" 
                        class="px-4 py-2 sm:px-6 sm:py-2.5 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition text-sm sm:text-base whitespace-nowrap flex items-center justify-center"
                    >
                        Clear All
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- Quick Filter Presets -->
        <div class="mb-4 sm:mb-6">
            <div class="flex flex-wrap gap-2">
                <a href="?min_yield=3&sort_by=yield" 
                   class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    High Yield (3%+)
                </a>
                <a href="?sort_by=dividend_date" 
                   class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Upcoming Dividends
                </a>
                <a href="?tsx60=on" 
                   class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                    </svg>
                    TSX 60
                </a>
                <a href="?min_yield=1&max_yield=5&sort_by=yield" 
                   class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Balanced Yield
                </a>
                {% if user.is_authenticated %}
                <a href="?has_dividend=yes&sort_by=dividend_date" 
                   class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Dividend Payers
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Results Info, View Toggle, and Export -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-3 sm:mb-4">
            <div class="text-xs sm:text-sm text-gray-600">
                Showing <span class="font-semibold text-gray-900">{{ page_obj.start_index }}</span> - 
                <span class="font-semibold text-gray-900">{{ page_obj.end_index }}</span> of 
                <span class="font-semibold text-gray-900">{{ page_obj.paginator.count|intcomma }}</span> stocks
            </div>
            <div class="flex items-center gap-2">
                <!-- View Toggle -->
                <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                    <button onclick="setViewMode('table')" id="view-table-btn" 
                            class="px-3 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium transition view-toggle-btn active">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Table
                    </button>
                    <button onclick="setViewMode('grid')" id="view-grid-btn" 
                            class="px-3 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium transition view-toggle-btn">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        Grid
                    </button>
                </div>
                {% if user.is_authenticated and page_obj.paginator.count > 0 %}
                <a 
                    href="?export=1{% if search_query %}&search={{ search_query }}{% endif %}{% if sector_filter %}&sector={{ sector_filter }}{% endif %}{% if min_yield %}&min_yield={{ min_yield }}{% endif %}{% if max_yield %}&max_yield={{ max_yield }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if dividend_frequency %}&frequency={{ dividend_frequency }}{% endif %}{% if tsx60_only %}&tsx60=on{% endif %}{% if etf_only %}&etf=on{% endif %}{% if has_dividend_filter %}&has_dividend={{ has_dividend_filter }}{% endif %}" 
                    class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition text-xs sm:text-sm whitespace-nowrap"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export CSV
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Stocks Table View -->
        <div id="table-view" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto md:overflow-x-visible">
                <table class="w-full" style="table-layout: fixed; width: 100%; max-width: 100%;">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap" style="width: 15%; min-width: 100px;">Symbol</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="width: 25%; min-width: 120px; max-width: 250px;">Company</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap hidden sm:table-cell">Price</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap" style="width: 9%;">Dividend</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap hidden md:table-cell" style="width: 8%;">Yield</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap" style="width: 15%;">Ex-Date</th>
                            <th class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider whitespace-nowrap">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in stocks_with_dividends %}
                        <tr class="hover:bg-blue-50 transition-colors">
                            <!-- Symbol -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap" style="min-width: 100px;">
                                <div class="flex items-center space-x-1.5 sm:space-x-2">
                                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                                        <span class="text-white font-bold text-xs sm:text-sm">{{ item.stock.symbol|slice:":1" }}</span>
                                    </div>
                                    <div class="min-w-0">
                                        <div class="flex items-center space-x-1 sm:space-x-2">
                                            <span class="text-sm sm:text-base md:text-lg font-bold text-gray-900">{{ item.stock.symbol }}</span>
                                            {% if item.has_dividend %}
                                            <span class="inline-flex items-center px-1.5 py-0.5 sm:px-2 sm:py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200 flex-shrink-0">
                                                Div
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-500 font-medium">
                                            {% if item.latest_dividend and item.latest_dividend.frequency %}
                                                {{ item.latest_dividend.frequency }}
                                            {% else %}
                                                {{ item.stock.code }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Company Name -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4" style="width: 25%; min-width: 120px; max-width: 250px;">
                                <div class="text-xs sm:text-sm font-semibold text-gray-900" style="word-break: break-word; overflow-wrap: break-word; hyphens: auto; line-height: 1.4;">{{ item.stock.company_name }}</div>
                            </td>
                            
                            <!-- Price -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-right hidden sm:table-cell">
                                {% if item.latest_price %}
                                <div class="text-sm sm:text-base font-bold text-gray-900">${{ item.latest_price.price|floatformat:2 }}</div>
                                {% if item.price_change_7d is not None %}
                                <div class="flex items-center justify-end gap-1 mt-0.5">
                                    <span class="text-xs font-medium {% if item.price_change_7d >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {% if item.price_change_7d >= 0 %}+{% endif %}{{ item.price_change_7d|floatformat:1 }}%
                                    </span>
                                    <span class="text-xs text-gray-400">7d</span>
                                </div>
                                {% endif %}
                                {% else %}
                                <span class="text-xs sm:text-sm text-gray-400">â€”</span>
                                {% endif %}
                            </td>
                            
                            <!-- Dividend -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-right" style="width: 9%;">
                                {% if item.latest_dividend %}
                                <div class="text-sm sm:text-base font-bold text-gray-900">${{ item.latest_dividend.amount|floatformat:4 }}</div>
                                {% else %}
                                <span class="text-xs sm:text-sm text-gray-400">â€”</span>
                                {% endif %}
                            </td>
                            
                            <!-- Yield -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-right hidden md:table-cell" style="width: 8%;">
                                {% if item.latest_dividend and item.latest_dividend.yield_percent %}
                                {% with yield_val=item.latest_dividend.yield_percent %}
                                <div class="inline-flex items-center px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-bold border {% if yield_val >= 5 %}bg-red-100 text-red-700 border-red-200{% elif yield_val >= 3 %}bg-orange-100 text-orange-700 border-orange-200{% elif yield_val >= 1 %}bg-green-100 text-green-700 border-green-200{% else %}bg-blue-100 text-blue-700 border-blue-200{% endif %}">
                                    {{ yield_val|floatformat:2 }}%
                                </div>
                                {% endwith %}
                                {% else %}
                                <span class="text-xs sm:text-sm text-gray-400">â€”</span>
                                {% endif %}
                            </td>
                            
                            <!-- Ex-Date -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 text-right" style="width: 15%;">
                                {% if item.upcoming_dividend_date %}
                                <div class="inline-flex flex-col items-end">
                                    <div class="flex items-center space-x-1 sm:space-x-1.5 mb-0.5 sm:mb-1 whitespace-nowrap">
                                        <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="text-xs sm:text-sm font-bold text-blue-600">{{ item.upcoming_dividend_date|date:"M d, Y" }}</span>
                                    </div>
                                    {% if item.days_until is not None %}
                                    <div class="text-xs font-medium {% if item.days_until <= 3 %}text-red-600{% elif item.days_until <= 7 %}text-orange-600{% else %}text-green-600{% endif %}">
                                        {% if item.days_until == 0 %}
                                            Today
                                        {% elif item.days_until < 0 %}
                                            Passed
                                        {% else %}
                                            {{ item.days_until }}d
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-xs sm:text-sm text-gray-400">â€”</span>
                                {% endif %}
                            </td>
                            
                            <!-- Action -->
                            <td class="px-2 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <div class="flex items-center justify-center gap-2">
                                    {% if user.is_authenticated %}
                                    <button 
                                        onclick="toggleWatchlist({{ item.stock.id }}, this)"
                                        data-in-watchlist="{% if item.in_watchlist %}true{% else %}false{% endif %}"
                                        class="{% if item.in_watchlist %}text-green-600 hover:text-green-700{% else %}text-gray-400 hover:text-blue-600{% endif %} transition p-1.5 sm:p-2 rounded-lg hover:bg-gray-100"
                                        title="{% if item.in_watchlist %}Remove from watchlist{% else %}Add to watchlist{% endif %}"
                                    >
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="{% if item.in_watchlist %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                    {% endif %}
                                    <a 
                                        href="{% url 'stock_detail' item.stock.symbol item.stock.get_seo_slug %}" 
                                        class="inline-flex items-center justify-center px-2 py-1 sm:px-4 sm:py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs sm:text-sm font-medium rounded-lg transition shadow-sm whitespace-nowrap"
                                    >
                                        View
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-20 text-center">
                                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">No stocks found</h3>
                                <p class="text-gray-600 mb-6">
                                    {% if search_query or sector_filter %}
                                    Try adjusting your search or filters.
                                    {% else %}
                                    No stocks available at the moment.
                                    {% endif %}
                                </p>
                                {% if search_query or sector_filter %}
                                <a href="{% url 'all_stocks' %}" 
                                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                                    Clear Filters
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stocks Grid View -->
        <div id="grid-view" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
            {% for item in stocks_with_dividends %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 overflow-hidden group">
                <!-- Card Header -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                                <span class="text-white font-bold text-sm">{{ item.stock.symbol|slice:":1" }}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center gap-1.5 flex-wrap">
                                    <h3 class="text-base font-bold text-gray-900 truncate">{{ item.stock.symbol }}</h3>
                                    {% if item.has_dividend %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700 border border-green-200 flex-shrink-0">
                                        Div
                                    </span>
                                    {% endif %}
                                    {% if item.stock.tsx60_member %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700 border border-yellow-200 flex-shrink-0">
                                        TSX60
                                    </span>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-500 truncate mt-0.5">{{ item.stock.company_name }}</p>
                            </div>
                        </div>
                        {% if user.is_authenticated %}
                        <button 
                            onclick="toggleWatchlist({{ item.stock.id }}, this)"
                            data-in-watchlist="{% if item.in_watchlist %}true{% else %}false{% endif %}"
                            class="flex-shrink-0 {% if item.in_watchlist %}text-green-600 hover:text-green-700{% else %}text-gray-400 hover:text-blue-600{% endif %} transition p-1 rounded-lg hover:bg-gray-100"
                            title="{% if item.in_watchlist %}Remove from watchlist{% else %}Add to watchlist{% endif %}"
                        >
                            <svg class="w-5 h-5" fill="{% if item.in_watchlist %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Card Body -->
                <div class="p-4 space-y-3">
                    <!-- Price -->
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Price</div>
                        {% if item.latest_price %}
                        <div class="text-lg font-bold text-gray-900">${{ item.latest_price.price|floatformat:2 }}</div>
                        {% if item.price_change_7d is not None %}
                        <div class="flex items-center gap-1 mt-0.5">
                            <span class="text-xs font-medium {% if item.price_change_7d >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if item.price_change_7d >= 0 %}+{% endif %}{{ item.price_change_7d|floatformat:1 }}%
                            </span>
                            <span class="text-xs text-gray-400">7d</span>
                        </div>
                        {% endif %}
                        {% else %}
                        <span class="text-sm text-gray-400">â€”</span>
                        {% endif %}
                    </div>
                    
                    <!-- Dividend Info -->
                    {% if item.latest_dividend %}
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="text-xs text-gray-600 mb-1">Dividend</div>
                            <div class="text-sm font-bold text-gray-900">${{ item.latest_dividend.amount|floatformat:4 }}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600 mb-1">Yield</div>
                            {% if item.latest_dividend.yield_percent %}
                            {% with yield_val=item.latest_dividend.yield_percent %}
                            <div class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold border {% if yield_val >= 5 %}bg-red-100 text-red-700 border-red-200{% elif yield_val >= 3 %}bg-orange-100 text-orange-700 border-orange-200{% elif yield_val >= 1 %}bg-green-100 text-green-700 border-green-200{% else %}bg-blue-100 text-blue-700 border-blue-200{% endif %}">
                                {{ yield_val|floatformat:2 }}%
                            </div>
                            {% endwith %}
                            {% else %}
                            <span class="text-xs text-gray-400">â€”</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Ex-Date -->
                    {% if item.upcoming_dividend_date %}
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Next Ex-Date</div>
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3 h-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span class="text-sm font-semibold text-blue-600">{{ item.upcoming_dividend_date|date:"M d, Y" }}</span>
                        </div>
                        {% if item.days_until is not None %}
                        <div class="text-xs font-medium mt-0.5 {% if item.days_until <= 3 %}text-red-600{% elif item.days_until <= 7 %}text-orange-600{% else %}text-green-600{% endif %}">
                            {% if item.days_until == 0 %}Today{% elif item.days_until < 0 %}Passed{% else %}{{ item.days_until }} days{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Sector -->
                    {% if item.stock.sector %}
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Sector</div>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                            {{ item.stock.sector }}
                        </span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Card Footer -->
                <div class="p-4 border-t border-gray-100 bg-gray-50">
                    <a href="{% url 'stock_detail' item.stock.symbol item.stock.get_seo_slug %}" 
                       class="block w-full text-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition shadow-sm hover:shadow-md">
                        View Details
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No stocks found</h3>
                <p class="text-gray-600 mb-6">
                    {% if search_query or sector_filter %}
                    Try adjusting your search or filters.
                    {% else %}
                    No stocks available at the moment.
                    {% endif %}
                </p>
                {% if search_query or sector_filter %}
                <a href="{% url 'all_stocks' %}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                    Clear Filters
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if user.is_authenticated and page_obj.paginator.num_pages > 1 %}
        <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-0">
            <div class="text-xs sm:text-sm text-gray-600">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </div>
            <div class="flex items-center gap-1.5 sm:gap-2">
                {% if page_obj.has_previous %}
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if sector_filter %}&sector={{ sector_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                   class="px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap">
                    First
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sector_filter %}&sector={{ sector_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                   class="px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap">
                    Previous
                </a>
                {% endif %}
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sector_filter %}&sector={{ sector_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                   class="px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap">
                    Next
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sector_filter %}&sector={{ sector_filter }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                   class="px-3 py-1.5 sm:px-4 sm:py-2 border border-gray-300 rounded-lg text-xs sm:text-sm text-gray-700 hover:bg-gray-50 transition whitespace-nowrap">
                    Last
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Search Autocomplete
(function() {
    const searchInput = document.getElementById('stock-search-input');
    const autocompleteResults = document.getElementById('autocomplete-results');
    const recentSearches = document.getElementById('recent-searches');
    const recentSearchesList = document.getElementById('recent-searches-list');
    let autocompleteTimeout;
    let selectedIndex = -1;
    
    if (!searchInput) return;
    
    searchInput.addEventListener('focus', function() {
        if (!this.value.trim() && recentSearchesList.children.length > 0) {
            recentSearches.classList.remove('hidden');
            autocompleteResults.classList.add('hidden');
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#search-container')) {
            autocompleteResults.classList.add('hidden');
            recentSearches.classList.add('hidden');
        }
    });
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(autocompleteTimeout);
        recentSearches.classList.add('hidden');
        
        if (query.length < 2) {
            autocompleteResults.classList.add('hidden');
            if (query.length === 0 && recentSearchesList.children.length > 0) {
                recentSearches.classList.remove('hidden');
            }
            return;
        }
        
        autocompleteTimeout = setTimeout(function() {
            fetch(`/api/stock-search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayAutocompleteResults(data.results);
                })
                .catch(error => {
                    console.error('Autocomplete error:', error);
                });
        }, 300);
    });
    
    searchInput.addEventListener('keydown', function(e) {
        const items = autocompleteResults.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
            e.preventDefault();
            items[selectedIndex].click();
        } else if (e.key === 'Escape') {
            autocompleteResults.classList.add('hidden');
            recentSearches.classList.add('hidden');
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-blue-50', 'border-blue-500');
            } else {
                item.classList.remove('bg-blue-50', 'border-blue-500');
            }
        });
    }
    
    function displayAutocompleteResults(results) {
        if (results.length === 0) {
            autocompleteResults.classList.add('hidden');
            return;
        }
        
        autocompleteResults.innerHTML = '';
        selectedIndex = -1;
        
        results.forEach((stock) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item p-3 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition';
            item.dataset.url = stock.url;
            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-gray-900">${escapeHtml(stock.symbol)}</span>
                            <span class="text-xs text-gray-500">${escapeHtml(stock.code)}</span>
                            ${stock.sector ? `<span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-700 rounded">${escapeHtml(stock.sector)}</span>` : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${escapeHtml(stock.company_name)}</p>
                    </div>
                </div>
            `;
            
            item.addEventListener('click', function() {
                window.location.href = stock.url;
            });
            
            autocompleteResults.appendChild(item);
        });
        
        autocompleteResults.classList.remove('hidden');
    }
    
    document.querySelectorAll('.recent-search-item').forEach(item => {
        item.addEventListener('click', function() {
            const searchTerm = this.dataset.search;
            searchInput.value = searchTerm;
            searchInput.closest('form').submit();
        });
    });
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
})();

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Watchlist Toggle
function toggleWatchlist(stockId, button) {
    const isInWatchlist = button.dataset.inWatchlist === 'true';
    
    // Disable button during request
    button.disabled = true;
    button.style.opacity = '0.6';
    
    fetch(`/watchlist/toggle/${stockId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Network response was not ok');
            });
        }
        return response.json();
    })
    .then(data => {
        button.disabled = false;
        button.style.opacity = '1';
        
        if (data.status === 'added' || data.status === 'removed') {
            button.dataset.inWatchlist = data.status === 'added' ? 'true' : 'false';
            const svg = button.querySelector('svg');
            if (data.status === 'added') {
                // Added to watchlist
                button.classList.remove('text-gray-400', 'hover:text-blue-600');
                button.classList.add('text-green-600', 'hover:text-green-700');
                svg.setAttribute('fill', 'currentColor');
                
                if (typeof Toast !== 'undefined') {
                    Toast.success(data.message || 'Added to watchlist');
                }
            } else {
                // Removed from watchlist
                button.classList.remove('text-green-600', 'hover:text-green-700');
                button.classList.add('text-gray-400', 'hover:text-blue-600');
                svg.setAttribute('fill', 'none');
                
                if (typeof Toast !== 'undefined') {
                    Toast.success(data.message || 'Removed from watchlist');
                }
            }
        } else if (data.status === 'error') {
            if (typeof Toast !== 'undefined') {
                Toast.error(data.message || 'Error updating watchlist');
            }
        }
    })
    .catch(error => {
        button.disabled = false;
        button.style.opacity = '1';
        console.error('Watchlist toggle error:', error);
        const errorMsg = error.message || 'Error updating watchlist. Please try again.';
        if (typeof Toast !== 'undefined') {
            Toast.error(errorMsg);
        }
    });
}

// View Mode Toggle
function setViewMode(mode) {
    const tableView = document.getElementById('table-view');
    const gridView = document.getElementById('grid-view');
    const tableBtn = document.getElementById('view-table-btn');
    const gridBtn = document.getElementById('view-grid-btn');
    
    if (mode === 'table') {
        tableView.classList.remove('hidden');
        gridView.classList.add('hidden');
        tableBtn.classList.add('active', 'bg-blue-600', 'text-white');
        tableBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
        gridBtn.classList.remove('active', 'bg-blue-600', 'text-white');
        gridBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
        localStorage.setItem('stocksViewMode', 'table');
    } else {
        tableView.classList.add('hidden');
        gridView.classList.remove('hidden');
        gridBtn.classList.add('active', 'bg-blue-600', 'text-white');
        gridBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
        tableBtn.classList.remove('active', 'bg-blue-600', 'text-white');
        tableBtn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
        localStorage.setItem('stocksViewMode', 'grid');
    }
}

// Restore view mode from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('stocksViewMode') || 'table';
    setViewMode(savedMode);
});

</script>

<style>
.view-toggle-btn.active {
    background-color: #2563eb;
    color: white;
}
.view-toggle-btn:not(.active) {
    background-color: white;
    color: #374151;
}
.view-toggle-btn:not(.active):hover {
    background-color: #f9fafb;
}
</style>
{% endblock %}
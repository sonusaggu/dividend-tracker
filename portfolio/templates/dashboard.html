{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <!-- Logo -->
        <a href="{% url 'dashboard' %}" class="flex items-center space-x-2">
          <span class="text-2xl">📊</span>
          <span class="text-xl font-bold text-gray-800">StockFolio</span>
        </a>
        <!-- Desktop Navigation -->
        <div class="hidden md:flex items-center space-x-8">
          <a href="{% url 'dashboard' %}" class="text-blue-600 border-b-2 border-blue-600 font-medium">Dashboard</a>
          <a href="{% url 'all_stocks' %}" class="text-gray-600 hover:text-blue-600 transition duration-200 font-medium">All Stocks</a>
          <a href="{% url 'portfolio' %}" class="text-gray-600 hover:text-blue-600 transition duration-200 font-medium">My Portfolio</a>
          <a href="#" class="text-gray-600 hover:text-blue-600 transition duration-200 font-medium">Alerts</a>
        </div>
        <!-- User Menu -->
        {% include 'navbar_user_menu.html' %}
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto py-8 px-4">
    <!-- Welcome Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back, {{ user.username }}! 👋</h1>
      <p class="text-gray-600">Here's your investment dashboard overview</p>
    </div>

    <!-- Quick Search -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-100">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">🔍 Quick Stock Search</h2>
      <form method="get" action="{% url 'all_stocks' %}" class="flex gap-4">
        <div class="flex-1 relative">
          <input type="text" name="search" placeholder="Search stocks by symbol or name..."
                 class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" />
          <span class="absolute left-3 top-3 text-gray-400">🔍</span>
        </div>
        <button type="submit"
                class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-medium transition transform hover:scale-105 shadow-md">
          Search
        </button>
      </form>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Portfolio Value -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Portfolio Value</p>
            <p class="text-2xl font-bold text-gray-900">${{ total_value|floatformat:2|default:"0.00" }}</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <span class="text-2xl text-green-600">💰</span>
          </div>
        </div>
        <p class="text-sm {% if total_gain_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-2">
          {% if total_value > 0 %}
            ${{ total_gain_loss|floatformat:2 }} ({{ percent_gain_loss|floatformat:2 }}%)
          {% else %}
            No investments yet
          {% endif %}
        </p>
      </div>

      <!-- Annual Dividends -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Annual Dividends</p>
            <p class="text-2xl font-bold text-gray-900">${{ annual_dividends|floatformat:2|default:"0.00" }}</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-2xl text-blue-600">📈</span>
          </div>
        </div>
        <p class="text-sm text-blue-600 mt-2">
          {% if total_value > 0 and annual_dividends > 0 %}
            {{ dividend_yield|floatformat:2 }}% yield
          {% else %}
            0.00% yield
          {% endif %}
        </p>
      </div>

      <!-- Total Holdings -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Holdings</p>
            <p class="text-2xl font-bold text-gray-900">{{ total_holdings|default:"0" }}</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
            <span class="text-2xl text-purple-600">📊</span>
          </div>
        </div>
        <p class="text-sm text-purple-600 mt-2">
          {% if total_holdings > 0 %}Across {{ sectors_count|default:1 }} sectors{% else %}No holdings yet{% endif %}
        </p>
      </div>

      <!-- Upcoming Dividends Count -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Upcoming Dividends</p>
            <p class="text-2xl font-bold text-gray-900">{{ upcoming_dividends_count|default:"0" }}</p>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <span class="text-2xl text-orange-600">📅</span>
          </div>
        </div>
        <p class="text-sm text-orange-600 mt-2">Next 30 days</p>
      </div>
    </div>

    <!-- Portfolio Performance & Watchlist -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Portfolio Performance -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-gray-900">📈 Portfolio Performance</h2>
          <span class="{% if total_value > 0 and percent_gain_loss >= 0 %}text-green-600{% elif total_value > 0 and percent_gain_loss < 0 %}text-red-600{% else %}text-gray-600{% endif %} font-semibold">
            {% if total_value > 0 %}${{ total_gain_loss|floatformat:2 }} ({{ percent_gain_loss|floatformat:2 }}%){% else %}No data{% endif %}
          </span>
        </div>

        <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 h-48 mb-4 overflow-hidden flex items-center justify-center relative">
          {% if total_value > 0 and performance_data %}
            <div class="absolute inset-0 flex justify-between items-end px-2">
              {% for perf in performance_data %}
                <div class="flex flex-col items-center w-full mx-1">
                  <div class="bg-blue-600 w-full rounded-t-md transition-all duration-1000 ease-in-out"
                       style="height: {{ perf.percent }}%;">
                  </div>
                  <p class="text-xs mt-2 text-gray-600">{{ perf.month }}</p>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center">
              <span class="text-4xl">📊</span>
              <p class="text-gray-600 mt-2">No portfolio data</p>
              <p class="text-sm text-gray-500">Add stocks to see performance</p>
            </div>
          {% endif %}
        </div>

        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-2xl font-bold {% if monthly_performance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
              {% if monthly_performance != None %}{{ monthly_performance|floatformat:2 }}%{% else %}--{% endif %}
            </p>
            <p class="text-sm text-gray-600">1 Month</p>
          </div>
          <div>
            <p class="text-2xl font-bold {% if quarterly_performance >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
              {% if quarterly_performance != None %}{{ quarterly_performance|floatformat:2 }}%{% else %}--{% endif %}
            </p>
            <p class="text-sm text-gray-600">3 Months</p>
          </div>
          <div>
            <p class="text-2xl font-bold {% if yearly_performance >= 0 %}text-purple-600{% else %}text-red-600{% endif %}">
              {% if yearly_performance != None %}{{ yearly_performance|floatformat:2 }}%{% else %}--{% endif %}
            </p>
            <p class="text-sm text-gray-600">1 Year</p>
          </div>
        </div>
      </div>

      <!-- Watchlist -->
      <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-gray-900">⭐ Watchlist</h2>
          <a href="{% url 'watchlist' %}" class="text-blue-600 hover:text-blue-800 text-sm">View All</a>
        </div>
        <div class="space-y-3">
          {% for item in watchlist_stocks %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition">
              <div class="flex items-center space-x-3">
                <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center font-semibold text-blue-600">
                  {{ item.symbol|slice:":1" }}
                </span>
                <div>
                  <p class="font-semibold text-gray-900">{{ item.symbol }}</p>
                  <p class="text-sm text-gray-600">{{ item.company_name|truncatewords:3 }}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-semibold text-gray-900">${{ item.latest_price|floatformat:2 }}</p>
                <span class="text-sm {% if item.change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                  {{ item.change|floatformat:2 }}%
                </span>
              </div>
            </div>
          {% empty %}
            <div class="text-center py-8">
              <span class="text-4xl">🔍</span>
              <p class="text-gray-600 mt-2">No stocks in watchlist</p>
              <a href="{% url 'all_stocks' %}" class="text-blue-600 hover:text-blue-800 text-sm">Add some stocks</a>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Upcoming Dividends -->
    <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mt-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">📅 Upcoming Dividends</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for dividend in upcoming_dividends %}
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-4">
            <div class="flex items-center justify-between mb-3">
              <span class="font-semibold text-gray-900">{{ dividend.stock.symbol }}</span>
              <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">{{ dividend.days_until }} days</span>
            </div>
            <p class="text-2xl font-bold text-green-600">${{ dividend.amount }}</p>
            <p class="text-sm text-gray-600">Ex-date: {{ dividend.ex_dividend_date|date:"M d" }}</p>
          </div>
        {% empty %}
          <div class="col-span-full text-center py-8">
            <span class="text-4xl">📊</span>
            <p class="text-gray-600 mt-2">No upcoming dividends</p>
            <p class="text-sm text-gray-500">Dividends from your holdings will appear here</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.bg-blue-600').forEach(bar => {
      const height = bar.style.height;
      bar.style.height = '0%';
      setTimeout(() => {
        bar.style.transition = 'height 1s ease-in-out';
        bar.style.height = height;
      }, 300);
    });
  });
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Stock Comparison Tool - Compare Stocks Side-by-Side | StockFolio{% endblock %}
{% block meta_title %}Stock Comparison Tool - Compare Dividend Stocks{% endblock %}
{% block meta_description %}Compare up to 3 stocks side-by-side. Compare dividend yield, P/E ratio, growth, price, and more. Make informed investment decisions.{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">Stock Comparison</h1>
                    <p class="text-gray-600">Compare up to 3 stocks side-by-side with real-time data</p>
                </div>
                <a href="{% url 'all_stocks' %}" 
                   class="inline-flex items-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition shadow-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Browse Stocks
                </a>
            </div>
        </div>
        
        <!-- Stock Selector Form -->
        <form method="get" action="{% url 'stock_comparison' %}" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative">
                    <label for="symbol1" class="block text-sm font-medium text-gray-700 mb-2">Stock 1</label>
                    <div class="relative">
                        <input type="text" 
                               id="symbol1" 
                               name="symbol1" 
                               value="{{ symbols.0|default:'' }}" 
                               placeholder="Search stock symbol or name..."
                               autocomplete="off"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                               required>
                        <div id="autocomplete-results-1" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="relative">
                    <label for="symbol2" class="block text-sm font-medium text-gray-700 mb-2">Stock 2</label>
                    <div class="relative">
                        <input type="text" 
                               id="symbol2" 
                               name="symbol2" 
                               value="{{ symbols.1|default:'' }}" 
                               placeholder="Search stock symbol or name..."
                               autocomplete="off"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                               required>
                        <div id="autocomplete-results-2" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="relative">
                    <label for="symbol3" class="block text-sm font-medium text-gray-700 mb-2">Stock 3 (Optional)</label>
                    <div class="relative">
                        <input type="text" 
                               id="symbol3" 
                               name="symbol3" 
                               value="{{ symbols.2|default:'' }}" 
                               placeholder="Search stock symbol or name..."
                               autocomplete="off"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <div id="autocomplete-results-3" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <button type="submit" 
                        class="flex-1 sm:flex-none px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-medium shadow-sm">
                    Compare Stocks
                </button>
                <button type="button" 
                        id="reset-form-btn"
                        class="flex-1 sm:flex-none px-6 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reset
                </button>
            </div>
        </form>
        
        {% if stocks_data %}
        <!-- Comparison Results -->
        <div class="space-y-8">
            <!-- Quick Actions & Summary Card -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {% for data in stocks_data %}
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg border border-blue-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">{{ data.stock.symbol }}</h3>
                            <p class="text-sm text-gray-600 mt-1">{{ data.stock.company_name|truncatewords:5 }}</p>
                        </div>
                        {% if data.latest_price %}
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900">${{ data.latest_price.last_price|floatformat:2 }}</p>
                            {% if data.price_change_7d is not None %}
                            <p class="text-sm font-medium {% if data.price_change_7d >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if data.price_change_7d >= 0 %}+{% endif %}{{ data.price_change_7d|floatformat:1 }}% (7d)
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% if user.is_authenticated %}
                    <div class="flex gap-2 mt-4">
                        <button onclick="toggleWatchlist({{ data.stock.id }})" 
                                id="watchlist-btn-{{ data.stock.id }}"
                                class="flex-1 px-4 py-2 text-sm font-medium rounded-lg transition {% if data.in_watchlist %}bg-blue-600 text-white hover:bg-blue-700{% else %}bg-white text-blue-600 border border-blue-600 hover:bg-blue-50{% endif %}">
                            {% if data.in_watchlist %}‚úì In Watchlist{% else %}+ Add to Watchlist{% endif %}
                        </button>
                        <button onclick="window.location.href='{% url 'add_to_portfolio' data.stock.symbol %}'" 
                                class="flex-1 px-4 py-2 text-sm font-medium rounded-lg transition {% if data.in_portfolio %}bg-green-600 text-white hover:bg-green-700{% else %}bg-white text-green-600 border border-green-600 hover:bg-green-50{% endif %}">
                            {% if data.in_portfolio %}‚úì In Portfolio{% else %}+ Add to Portfolio{% endif %}
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <!-- Winners Summary Card -->
            {% if winners %}
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl shadow-lg border border-green-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    Comparison Winners
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% if winners.dividend_yield is not None %}
                    <div class="bg-white rounded-lg p-3 border border-green-200">
                        <p class="text-xs text-gray-600 mb-1">Best Dividend Yield</p>
                        <p class="text-lg font-bold text-green-700">{% for data in stocks_data %}{% if forloop.counter0 == winners.dividend_yield %}{{ data.stock.symbol }}{% endif %}{% endfor %}</p>
                    </div>
                    {% endif %}
                    {% if winners.pe_ratio is not None %}
                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                        <p class="text-xs text-gray-600 mb-1">Best P/E Ratio (Lowest)</p>
                        <p class="text-lg font-bold text-blue-700">{% for data in stocks_data %}{% if forloop.counter0 == winners.pe_ratio %}{{ data.stock.symbol }}{% endif %}{% endfor %}</p>
                    </div>
                    {% endif %}
                    {% if winners.price_change_7d is not None %}
                    <div class="bg-white rounded-lg p-3 border border-purple-200">
                        <p class="text-xs text-gray-600 mb-1">Best 7-Day Performance</p>
                        <p class="text-lg font-bold text-purple-700">{% for data in stocks_data %}{% if forloop.counter0 == winners.price_change_7d %}{{ data.stock.symbol }}{% endif %}{% endfor %}</p>
                    </div>
                    {% endif %}
                    {% if winners.growth_3_year is not None %}
                    <div class="bg-white rounded-lg p-3 border border-orange-200">
                        <p class="text-xs text-gray-600 mb-1">Best 3-Year Growth</p>
                        <p class="text-lg font-bold text-orange-700">{% for data in stocks_data %}{% if forloop.counter0 == winners.growth_3_year %}{{ data.stock.symbol }}{% endif %}{% endfor %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Price Comparison Chart -->
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="text-2xl mr-3">üìà</span>
                    Price Comparison
                </h2>
                <canvas id="priceChart" height="80"></canvas>
            </div>
            
            <!-- Dividend Yield Comparison Chart -->
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="text-2xl mr-3">üí∞</span>
                    Dividend Yield Comparison
                </h2>
                <canvas id="yieldChart" height="80"></canvas>
            </div>
            
            <!-- P/E Ratio Comparison Chart -->
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <span class="text-2xl mr-3">üìä</span>
                    P/E Ratio Comparison
                </h2>
                <canvas id="peChart" height="80"></canvas>
            </div>
            
            <!-- Side-by-Side Comparison Table -->
            <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8 border border-gray-100">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4 md:mb-6 flex items-center">
                    <span class="text-xl md:text-2xl mr-3">üìã</span>
                    Detailed Comparison
                </h2>
                
                <div class="overflow-x-auto -mx-4 md:mx-0" style="-webkit-overflow-scrolling: touch;">
                    <div class="inline-block min-w-full align-middle px-4 md:px-0">
                        <table class="w-full min-w-[800px] md:min-w-0">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">Metric</th>
                                {% for data in stocks_data %}
                                <th class="text-center py-4 px-4 font-semibold text-gray-700">
                                    <div class="flex flex-col items-center">
                                        <a href="{% url 'stock_detail' symbol=data.stock.symbol %}" 
                                           class="text-xl font-bold text-blue-600 hover:text-blue-800 hover:underline">
                                            {{ data.stock.symbol }}
                                        </a>
                                        <span class="text-sm text-gray-500 mt-1">{{ data.stock.company_name|truncatewords:4 }}</span>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <!-- Current Price -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Current Price</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if forloop.counter0 == 0 %}border-l-4 border-blue-500{% endif %}">
                                    {% if data.latest_price %}
                                        <div>
                                            <span class="text-xl font-bold text-gray-900">${{ data.latest_price.last_price|floatformat:2 }}</span>
                                            {% if data.price_change_7d is not None %}
                                            <div class="text-xs mt-1">
                                                <span class="font-medium {% if data.price_change_7d >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                    {% if data.price_change_7d >= 0 %}+{% endif %}{{ data.price_change_7d|floatformat:1 }}% (7d)
                                                </span>
                                                {% if data.price_change_30d is not None %}
                                                <span class="text-gray-500 ml-2">
                                                    {% if data.price_change_30d >= 0 %}+{% endif %}{{ data.price_change_30d|floatformat:1 }}% (30d)
                                                </span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- 52-Week Range -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">52-Week Range</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.latest_price and data.latest_price.fiftytwo_week_low and data.latest_price.fiftytwo_week_high %}
                                        <div class="text-sm">
                                            <div class="font-semibold text-gray-900">${{ data.latest_price.fiftytwo_week_low|floatformat:2 }} - ${{ data.latest_price.fiftytwo_week_high|floatformat:2 }}</div>
                                            {% if data.price_change_52w %}
                                            <div class="text-xs text-gray-500 mt-1">
                                                {{ data.price_change_52w|floatformat:1 }}% from low
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Dividend Yield -->
                            <tr class="hover:bg-gray-50 bg-green-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Dividend Yield</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if winners.dividend_yield == forloop.counter0 %}bg-green-100 border-2 border-green-500 rounded-lg{% endif %}">
                                    {% if data.dividend and data.dividend.yield_percent %}
                                        <div class="flex flex-col items-center">
                                            <span class="text-xl font-bold text-green-600">{{ data.dividend.yield_percent|floatformat:2 }}%</span>
                                            {% if winners.dividend_yield == forloop.counter0 %}
                                            <span class="text-xs text-green-700 font-semibold mt-1">üèÜ Winner</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Dividend Amount -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Dividend Amount</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.dividend %}
                                        <span class="text-lg font-semibold text-gray-900">${{ data.dividend.amount|floatformat:4 }}</span>
                                        {% if data.dividend.frequency %}
                                        <div class="text-xs text-gray-500 mt-1">{{ data.dividend.frequency }}</div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- P/E Ratio -->
                            <tr class="hover:bg-gray-50 bg-purple-50">
                                <td class="py-4 px-4 font-medium text-gray-700">P/E Ratio <span class="text-xs text-gray-500">(Lower is better)</span></td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if winners.pe_ratio == forloop.counter0 %}bg-purple-100 border-2 border-purple-500 rounded-lg{% endif %}">
                                    {% if data.valuation and data.valuation.pe_ratio %}
                                        <div class="flex flex-col items-center">
                                            <span class="text-xl font-bold text-purple-600">{{ data.valuation.pe_ratio|floatformat:2 }}</span>
                                            {% if winners.pe_ratio == forloop.counter0 %}
                                            <span class="text-xs text-purple-700 font-semibold mt-1">üèÜ Winner</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Payout Ratio -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Payout Ratio</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.payout_ratio is not None %}
                                        <span class="text-lg font-semibold {% if data.payout_ratio > 100 %}text-red-600{% elif data.payout_ratio > 80 %}text-orange-600{% else %}text-green-600{% endif %}">
                                            {{ data.payout_ratio|floatformat:1 }}%
                                        </span>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Dividend Growth -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Dividend Growth</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if winners.dividend_growth == forloop.counter0 %}bg-green-100 border-2 border-green-500 rounded-lg{% endif %}">
                                    {% if data.dividend_growth is not None %}
                                        <div class="flex flex-col items-center">
                                            <span class="text-lg font-semibold {% if data.dividend_growth >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {% if data.dividend_growth >= 0 %}+{% endif %}{{ data.dividend_growth|floatformat:1 }}%
                                            </span>
                                            {% if winners.dividend_growth == forloop.counter0 %}
                                            <span class="text-xs text-green-700 font-semibold mt-1">üèÜ Winner</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- EPS -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Earnings Per Share (EPS)</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.valuation and data.valuation.eps %}
                                        <span class="text-lg font-semibold text-gray-900">${{ data.valuation.eps|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Market Cap -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Market Cap</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.valuation and data.valuation.market_cap %}
                                        <span class="text-lg font-semibold text-gray-900">{{ data.valuation.market_cap }}</span>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- 3-Year Growth -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">3-Year Growth</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if winners.growth_3_year == forloop.counter0 %}bg-green-100 border-2 border-green-500 rounded-lg{% endif %}">
                                    {% if data.valuation and data.valuation.growth_3_year is not None %}
                                        <div class="flex flex-col items-center">
                                            <span class="text-lg font-semibold {% if data.valuation.growth_3_year > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {{ data.valuation.growth_3_year|floatformat:2 }}%
                                            </span>
                                            {% if winners.growth_3_year == forloop.counter0 %}
                                            <span class="text-xs text-green-700 font-semibold mt-1">üèÜ Winner</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- 5-Year Growth -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">5-Year Growth</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center {% if winners.growth_5_year == forloop.counter0 %}bg-green-100 border-2 border-green-500 rounded-lg{% endif %}">
                                    {% if data.valuation and data.valuation.growth_5_year is not None %}
                                        <div class="flex flex-col items-center">
                                            <span class="text-lg font-semibold {% if data.valuation.growth_5_year > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {{ data.valuation.growth_5_year|floatformat:2 }}%
                                            </span>
                                            {% if winners.growth_5_year == forloop.counter0 %}
                                            <span class="text-xs text-green-700 font-semibold mt-1">üèÜ Winner</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Sector -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Sector</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.stock.sector %}
                                        <span class="text-sm font-medium text-gray-700 bg-blue-100 px-3 py-1 rounded-full">{{ data.stock.sector }}</span>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Industry -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Industry</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.stock.industry %}
                                        <span class="text-sm font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full">{{ data.stock.industry }}</span>
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Analyst Rating -->
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-4 font-medium text-gray-700">Analyst Rating</td>
                                {% for data in stocks_data %}
                                <td class="py-4 px-4 text-center">
                                    {% if data.analyst_rating and data.analyst_rating.analyst_rating %}
                                        <span class="text-lg font-semibold text-gray-900">{{ data.analyst_rating.analyst_rating }}</span>
                                        {% if data.analyst_rating.buy_count or data.analyst_rating.hold_count or data.analyst_rating.sell_count %}
                                        <div class="text-xs text-gray-500 mt-1">
                                            Buy: {{ data.analyst_rating.buy_count|default:0 }}, 
                                            Hold: {{ data.analyst_rating.hold_count|default:0 }}, 
                                            Sell: {{ data.analyst_rating.sell_count|default:0 }}
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center md:hidden">‚Üê Swipe horizontally to see more columns ‚Üí</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
    @keyframes spin-slow {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    
    .animate-spin-slow {
        animation: spin-slow 3s linear infinite;
    }
    
    @keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }
    
    .animate-float {
        animation: float 3s ease-in-out infinite;
    }
    
    .animation-delay-100 {
        animation-delay: 0.1s;
    }
    
    .animation-delay-200 {
        animation-delay: 0.2s;
    }
</style>

<script>
// Stock Search Autocomplete for Comparison Tool
(function() {
    // Initialize autocomplete for each input field
    ['symbol1', 'symbol2', 'symbol3'].forEach(function(fieldId, index) {
        const input = document.getElementById(fieldId);
        const resultsContainer = document.getElementById(`autocomplete-results-${index + 1}`);
        let autocompleteTimeout;
        let selectedIndex = -1;
        let isSelecting = false; // Flag to prevent dropdown from reopening after selection
        
        if (!input || !resultsContainer) return;
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Handle input for autocomplete
        input.addEventListener('input', function() {
            // Don't show autocomplete if we just selected an item
            if (isSelecting) {
                isSelecting = false;
                return;
            }
            
            const query = this.value.trim();
            
            // Clear previous timeout
            clearTimeout(autocompleteTimeout);
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                selectedIndex = -1;
                return;
            }
            
            // Debounce autocomplete requests
            autocompleteTimeout = setTimeout(function() {
                fetch(`/api/stock-search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        displayAutocompleteResults(data.results, resultsContainer, input);
                    })
                    .catch(error => {
                        console.error('Autocomplete error:', error);
                    });
            }, 300); // 300ms debounce
        });
        
        // Handle keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = resultsContainer.querySelectorAll('.autocomplete-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
                e.preventDefault();
                selectStock(items[selectedIndex], input, e);
            } else if (e.key === 'Escape') {
                resultsContainer.classList.add('hidden');
                selectedIndex = -1;
            }
        });
        
        // Show autocomplete on focus if there's text
        input.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                const query = this.value.trim();
                fetch(`/api/stock-search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        displayAutocompleteResults(data.results, resultsContainer, input);
                    })
                    .catch(error => {
                        console.error('Autocomplete error:', error);
                    });
            }
        });
        
        // Hide dropdown when clicking outside
        const inputContainer = input.closest('.relative');
        let clickOutsideHandler = function(e) {
            if (inputContainer && !inputContainer.contains(e.target)) {
                resultsContainer.classList.add('hidden');
                selectedIndex = -1;
            }
        };
        // Use capture phase to handle clicks before they bubble
        document.addEventListener('click', clickOutsideHandler, true);
        
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('bg-blue-50', 'border-blue-500');
                } else {
                    item.classList.remove('bg-blue-50', 'border-blue-500');
                }
            });
        }
        
        function selectStock(item, inputField, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const symbol = item.dataset.symbol;
            isSelecting = true; // Set flag to prevent dropdown from reopening
            inputField.value = symbol;
            resultsContainer.classList.add('hidden');
            selectedIndex = -1;
            // Clear any pending autocomplete requests
            clearTimeout(autocompleteTimeout);
        }
        
        function displayAutocompleteResults(results, container, inputField) {
            if (results.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.innerHTML = '';
            selectedIndex = -1;
            
            results.forEach((stock) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item p-4 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition duration-150';
                item.dataset.symbol = stock.symbol;
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg text-gray-900">${escapeHtml(stock.symbol)}</span>
                                <span class="text-xs text-gray-500">${escapeHtml(stock.code)}</span>
                                ${stock.sector ? `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">${escapeHtml(stock.sector)}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${escapeHtml(stock.company_name)}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    selectStock(item, inputField, e);
                });
                
                // Also handle mousedown to prevent focus issues
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault(); // Prevent input from losing focus
                });
                
                container.appendChild(item);
            });
            
            container.classList.remove('hidden');
        }
    });
})();

// Reset Form Button
(function() {
    const resetBtn = document.getElementById('reset-form-btn');
    const symbol1Input = document.getElementById('symbol1');
    const symbol2Input = document.getElementById('symbol2');
    const symbol3Input = document.getElementById('symbol3');
    const autocompleteResults1 = document.getElementById('autocomplete-results-1');
    const autocompleteResults2 = document.getElementById('autocomplete-results-2');
    const autocompleteResults3 = document.getElementById('autocomplete-results-3');
    
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // Clear all input fields
            if (symbol1Input) symbol1Input.value = '';
            if (symbol2Input) symbol2Input.value = '';
            if (symbol3Input) symbol3Input.value = '';
            
            // Hide all autocomplete dropdowns
            if (autocompleteResults1) autocompleteResults1.classList.add('hidden');
            if (autocompleteResults2) autocompleteResults2.classList.add('hidden');
            if (autocompleteResults3) autocompleteResults3.classList.add('hidden');
            
            // Focus on first input
            if (symbol1Input) symbol1Input.focus();
            
            // Scroll to top of form
            resetBtn.closest('form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    }
})();

{% if stocks_data %}
// Price Comparison Chart
const priceCtx = document.getElementById('priceChart').getContext('2d');
const priceChart = new Chart(priceCtx, {
    type: 'bar',
    data: {
        labels: [{% for data in stocks_data %}'{{ data.stock.symbol }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Current Price ($)',
            data: [{% for data in stocks_data %}{% if data.latest_price %}{{ data.latest_price.last_price }}{% else %}0{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(236, 72, 153, 0.8)'
            ],
            borderColor: [
                'rgba(59, 130, 246, 1)',
                'rgba(139, 92, 246, 1)',
                'rgba(236, 72, 153, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '$' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        }
    }
});

// Dividend Yield Comparison Chart
const yieldCtx = document.getElementById('yieldChart').getContext('2d');
const yieldChart = new Chart(yieldCtx, {
    type: 'bar',
    data: {
        labels: [{% for data in stocks_data %}'{{ data.stock.symbol }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Dividend Yield (%)',
            data: [{% for data in stocks_data %}{% if data.dividend and data.dividend.yield_percent %}{{ data.dividend.yield_percent }}{% else %}0{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(34, 197, 94, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(5, 150, 105, 0.8)'
            ],
            borderColor: [
                'rgba(34, 197, 94, 1)',
                'rgba(16, 185, 129, 1)',
                'rgba(5, 150, 105, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toFixed(2) + '%';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toFixed(2) + '%';
                    }
                }
            }
        }
    }
});

// P/E Ratio Comparison Chart
const peCtx = document.getElementById('peChart').getContext('2d');
const peChart = new Chart(peCtx, {
    type: 'bar',
    data: {
        labels: [{% for data in stocks_data %}'{{ data.stock.symbol }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'P/E Ratio',
            data: [{% for data in stocks_data %}{% if data.valuation and data.valuation.pe_ratio %}{{ data.valuation.pe_ratio }}{% else %}0{% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(139, 92, 246, 0.8)',
                'rgba(124, 58, 237, 0.8)',
                'rgba(109, 40, 217, 0.8)'
            ],
            borderColor: [
                'rgba(139, 92, 246, 1)',
                'rgba(124, 58, 237, 1)',
                'rgba(109, 40, 217, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'P/E: ' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toFixed(1);
                    }
                }
            }
        }
    }
});
{% endif %}

// Watchlist Toggle Function
function toggleWatchlist(stockId) {
    const btn = document.getElementById('watchlist-btn-' + stockId);
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin">‚è≥</span> Loading...';
    
    fetch(`/watchlist/toggle/${stockId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'added') {
            btn.classList.remove('bg-white', 'text-blue-600', 'border-blue-600', 'hover:bg-blue-50');
            btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            btn.innerHTML = '‚úì In Watchlist';
        } else if (data.status === 'removed') {
            btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            btn.classList.add('bg-white', 'text-blue-600', 'border', 'border-blue-600', 'hover:bg-blue-50');
            btn.innerHTML = '+ Add to Watchlist';
        }
        btn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('An error occurred. Please try again.');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

